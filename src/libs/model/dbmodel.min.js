var Promise,__apps,config,dbmodel,echo,fs,ndlog,sprintf,sqlite3;Promise=require("bluebird"),config=require("config"),sqlite3=require("sqlite3").verbose(),fs=require("fs-extra"),echo=(ndlog=require("ndlog")).echo,sprintf=ndlog.form,__apps=fs.realpathSync(process.cwd()),dbmodel=class{constructor(){var e;"develop"===process.env.NODE_ENV?("develop",e=`${__apps}/apps/develop/database`):("production",e=`${__apps}/apps/deploy/database`),this.SCHEMA=require(`${e}/schema.json`),this.DB=new sqlite3.Database(`${e}/${config.database.dbfile}`)}upsert(e){return new Promise((r,l)=>{var t,n,s,i,u,a,o;for(n in a=e.table||void 0,i=e.values||void 0,null!=a&&null!=i||l(-1),t=[],s=[],i)o=i[n],s.push(n),t.push(o);return u=`REPLACE INTO ${a} (${s.join(",")}) VALUES (${new Array(Object.keys(i).length).fill("?").join(",")})`,this.DB.all(u,t,(e,t)=>null!=e?l(e):r(0))})}delete(e){return new Promise((r,l)=>{var t,n,s,i,u,a,o;if(u=e.table||void 0,t=[],s=[],null==(o=e.where||void 0))i=`DELETE FROM ${u}`;else{for(n in o)a=o[n],s.push(`${n} like ?`),t.push(a);i=`DELETE FROM ${u} WHERE ${s.join(" AND ")}`}return this.DB.all(i,t,(e,t)=>e?l(e):r(t))})}select(e){return new Promise((r,l)=>{var t,n,s,i,u,a,o,E,d,h;if(t=[],h=[],i=void 0,u=void 0,s=void 0,a=`SELECT * FROM ${o=e.table||void 0}`,null!=(d=e.where||void 0)){for(n in d)E=d[n],"order_by"===n?i=` ORDER BY ${E}`:"sort"===n?"asc"===E?u="ASC":"desc"===E&&(u="DESC"):"limit"===n?s=E:(h.push(`${n} LIKE ?`),t.push(E));h.length>0&&(a=`SELECT * FROM ${o} WHERE ${h.join(" AND ")}`)}return null!=i&&(a+=i,null!=u&&(a+=` ${u}`)),null!=s&&(a+=" limit "+parseInt(s)),this.DB.all(a,t,(e,t)=>e?l(e):r(t))})}update(e){return new Promise((r,l)=>{var t,n,s,i,u,a,o,E,d,h;if(u=e.table||void 0,s=e.values||void 0,E=e.where||void 0,null==u||null==s)return-1;for(n in t=[],o=[],s)a=s[n],o.push(`${n}=?`),t.push(a);if(o.join(","),d=[],null!=E){for(n in E)a=E[n],d.push(`${n} LIKE ?`),t.push(a);d.length>0&&(h=d.join(" AND "))}return i=`UPDATE ${u} SET ${o}`,null!=E&&(i+=` WHERE ${h}`),this.DB.all(i,t,(e,t)=>null!=e?l(e):r(0))})}reset_autoincrement(e){return new Promise((r,l)=>{var t;return t=e.table||void 0,"delete from sqlite_sequence where name=?",this.DB.all("delete from sqlite_sequence where name=?",[t],(e,t)=>null!=e?l(e):r(0))})}objectForKey(e){return new Promise((r,l)=>{var t;return"keyvalue",t=e.key,"select * from keyvalue where key=?",this.DB.all("select * from keyvalue where key=?",[t],(e,t)=>null!=e?l(e):t.length>0?r(t[0].value):r(void 0))})}setObject(e){return new Promise((r,l)=>{var t,n;return"keyvalue",t=Object.keys(e.values)[0],n=e.values[t],null==t&&l(-1),"UPDATE keyvalue SET value=? WHERE key=?",this.DB.all("UPDATE keyvalue SET value=? WHERE key=?",[n,t],(e,t)=>null!=e?l(e):r(0))})}_exec_sql(e,r){return new Promise((l,t)=>this.DB.all(e,r,(e,r)=>null!=e?t(e):l(r)))}_add_column(e,r,l){var t;t=`ALTER TABLE ${e} ADD ${r} ${l};`;try{return this.DB.run(t),0}catch(e){return e,-1}}_get_table_schema(e){return new Promise((r,l)=>{var t,n;return"_all_"===e?(n="SELECT * FROM sqlite_master WHERE type='table'",t=[]):(n="SELECT * FROM sqlite_master WHERE type='table' AND name=?",t=[e]),this.DB.all(n,t,(e,t)=>null!=e?l(e):r(t))})}_create_table(e){var r;return r=this.SCHEMA[e],new Promise((l,t)=>{var n,s,i,u,a;if(""===r||null==r)return t(0);for(i in n=[],r)a=r[i],n.push(`${i} ${a}`);s=n.join(","),u=`CREATE TABLE IF NOT EXISTS ${e} (_id INTEGER PRIMARY KEY AUTOINCREMENT,${s});`;try{return this.DB.run(u),l(0)}catch(e){return t(e)}})}_drop_table(e){return new Promise((r,l)=>{return`DROP TABLE ${e};`,r(this.DB.run(sqlstr))})}},module.exports=new dbmodel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIjAiXSwibmFtZXMiOlsiUHJvbWlzZSIsIl9fYXBwcyIsImNvbmZpZyIsImRibW9kZWwiLCJlY2hvIiwiZnMiLCJuZGxvZyIsInNwcmludGYiLCJzcWxpdGUzIiwicmVxdWlyZSIsInZlcmJvc2UiLCJmb3JtIiwicmVhbHBhdGhTeW5jIiwicHJvY2VzcyIsImN3ZCIsIltvYmplY3QgT2JqZWN0XSIsImRicGF0aCIsImVudiIsIk5PREVfRU5WIiwidGhpcyIsIlNDSEVNQSIsIkRCIiwiRGF0YWJhc2UiLCJkYXRhYmFzZSIsImRiZmlsZSIsInBhcmFtIiwicmVzb2x2ZSIsInJlamVjdCIsImFyciIsImMiLCJjb2x1bW5fYXJyIiwiaW5zZXJ0X2RhdGEiLCJzcWwiLCJ0YWJsZSIsInYiLCJ2YWx1ZXMiLCJwdXNoIiwiam9pbiIsIkFycmF5IiwiT2JqZWN0Iiwia2V5cyIsImxlbmd0aCIsImZpbGwiLCJhbGwiLCJlcnIiLCJyZXMiLCJ3aGVyZSIsInJvd3MiLCJsaW1pdCIsIm9yZGVyYnkiLCJzb3J0Iiwid2hlcmVfYXJyIiwicGFyc2VJbnQiLCJ2YWx1ZXNfYXJyIiwid2hlcmVfc3RyIiwia2V5IiwidmFsdWUiLCJkYXRhIiwibmFtZSIsInR5cGUiLCJydW4iLCJlcnJvciIsInNjaGVtYSIsImNvbHVtbiIsImNvbHVtbnN0ciIsInZhbCIsInNxbHN0ciIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBLElBQUlBLFFBQVNDLE9BQVFDLE9BQVFDLFFBQVNDLEtBQU1DLEdBQUlDLE1BQU9DLFFBQVNDLFFBRWhFUixRQUFVUyxRQUFRLFlBRWxCUCxPQUFTTyxRQUFRLFVBRWpCRCxRQUFVQyxRQUFRLFdBQVdDLFVBRTdCTCxHQUFLSSxRQUFRLFlBSWJMLE1BRkFFLE1BQVFHLFFBQVEsVUFFSEwsS0FFYkcsUUFBVUQsTUFBTUssS0FFaEJWLE9BQVNJLEdBQUdPLGFBQWFDLFFBQVFDLE9BRWpDWCxRQUFVLE1BQ1JZLGNBQ0UsSUFBYUMsRUFFSSxZQURO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